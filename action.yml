name: "Junie GH Action v1.0"
description: "Powerful GitHub automation with Junie."
branding:
  icon: "at-sign"
  color: "green"

inputs:
  trigger_phrase:
    description: "The trigger phrase to look for in comments or issue body"
    required: false
    default: "@junie"
  assignee_trigger:
    description: "The assignee username that triggers the action (e.g. @junie)"
    required: false
  label_trigger:
    description: "The label that triggers the action (e.g. junie)"
    required: false
    default: "junie"
  base_branch:
    description: "The branch to use as the source when creating junie working branch"
    required: false
  resolve_conflicts:
    description: "Whether to resolve conflicts automatically"
    required: false
    default: "false"
  create_new_branch_for_pr:
    description: "Whether to create a new branch for PR instead of pushing to the same branch"
    required: false
    default: "false"
  silent_mode:
    description: "Silent mode - skip comments, branch creation, commits. Only prepare data and run Junie for output consumption."
    required: false
    default: "false"
  use_single_comment:
    description: "Use a single comment that gets updated instead of creating new comments for each run(per workflow)"
    required: false
    default: "false"

  # Junie configuration
  prompt:
    description: "Instructions for Junie. Can be a direct prompt or custom template."
    required: false
    default: ""
  junie_version:
    description: "Version of Junie to use"
    required: false
    default: "481.1.0"
  junie_work_dir:
    description: "Directory to use for Junie working files"
    required: false
    default: "/tmp/junie-work"
  allowed_mcp_servers:
    description: "Comma-separated list of github MCP servers to use. Allowed server names: mcp_github_checks_server"
    required: false

  # Auth configuration
  junie_api_key:
    description: "Junie API key"
    required: false
  custom_github_token:
    description: "GitHub token with repo and pull request permissions (optional if using GitHub App)"
    required: false

outputs:
  branch_name:
    description: "Junie working branch"
    value: ${{ steps.prepare.outputs.WORKING_BRANCH }}
  should_skip:
    description: "Whether Junie execution was skipped (no trigger matched or no write permissions)"
    value: ${{ steps.prepare.outputs.SHOULD_SKIP }}
  commit_sha:
    description: "SHA of the commit created by Junie (if any)"
    value: ${{ steps.commit.outputs.commit_long_sha }}
  pr_url:
    description: "URL of the pull request created by Junie (if any)"
    value: ${{ steps.pull-request.outputs.pull-request-url }}
  junie_title:
    description: "Title of the task completion from Junie"
    value: ${{ steps.junie-run-results.outputs.JUNIE_TITLE }}
  junie_summary:
    description: "Summary of the changes made by Junie"
    value: ${{ steps.junie-run-results.outputs.JUNIE_SUMMARY }}
  github_token:
    description: "The GitHub token used by the action"
    value: ${{ steps.prepare.outputs.EJ_AUTH_GITHUB_TOKEN }}

runs:
  using: "composite"
  steps:
    - name: Install Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: 1.3.0

    - name: Install Dependencies
      shell: bash
      run: |
        cd ${GITHUB_ACTION_PATH}
        bun install

    - name: Prepare action
      id: prepare
      shell: bash
      run: |
        bun run ${GITHUB_ACTION_PATH}/src/entrypoints/prepare.ts
      env:
        APP_TOKEN: ${{ inputs.junie_api_key }}
        PROMPT: ${{ inputs.prompt }}
        TRIGGER_PHRASE: ${{ inputs.trigger_phrase }}
        ASSIGNEE_TRIGGER: ${{ inputs.assignee_trigger }}
        LABEL_TRIGGER: ${{ inputs.label_trigger }}
        BASE_BRANCH: ${{ inputs.base_branch || github.base_ref  }}
        TARGET_BRANCH: ${{ github.head_ref }}
        OVERRIDE_GITHUB_TOKEN: ${{ inputs.custom_github_token }}
        DEFAULT_WORKFLOW_TOKEN: ${{ github.token }}
        JUNIE_WORKING_DIR: ${{ inputs.junie_work_dir }}
        ALLOWED_MCP_SERVERS: ${{ inputs.allowed_mcp_servers }}
        RESOLVE_CONFLICTS: ${{ inputs.resolve_conflicts }}
        CREATE_NEW_BRANCH_FOR_PR: ${{ inputs.create_new_branch_for_pr }}
        SILENT_MODE: ${{ inputs.silent_mode }}
        USE_SINGLE_COMMENT: ${{ inputs.use_single_comment }}
        ALL_INPUTS: ${{ toJson(inputs) }}


    - name: Install Junie
      if: steps.prepare.outputs.SHOULD_SKIP != 'true'
      shell: bash
      run: npm install -g @jetbrains/junie-cli@${{ inputs.junie_version }}

    - name: Run Junie
      if: steps.prepare.outputs.SHOULD_SKIP != 'true'
      shell: bash
      id: junie-run
      env:
        CLI_TOKEN: ${{ steps.prepare.outputs.EJ_CLI_TOKEN }}
        EJ_TASK: ${{ steps.prepare.outputs.EJ_TASK }}
        EJ_AUTH_GITHUB_TOKEN: ${{ steps.prepare.outputs.EJ_AUTH_GITHUB_TOKEN  }}
        EJ_TASK_TEXT: ${{ steps.prepare.outputs.EJ_TASK_TEXT }}
        MULTI_RUNS: true
        MATTERHORN_DEBUG_LOG: false
        WORKING_DIR: ${{ inputs.junie_work_dir }}
      run: |
        OUTPUT=$(junie --cache-dir="${WORKING_DIR}" --output-format="json" --auth="${CLI_TOKEN}" "${EJ_TASK}")
        echo "json_output<<EOF" >> $GITHUB_OUTPUT
        echo "$OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Handle Junie results
      if: steps.prepare.outputs.SHOULD_SKIP != 'true'
      shell: bash
      id: junie-run-results
      run: |
        bun run ${GITHUB_ACTION_PATH}/src/entrypoints/handle-results.ts
      env:
        JSON_JUNIE_OUTPUT: ${{ steps.junie-run.outputs.json_output }}
        PARSED_CONTEXT: ${{ steps.prepare.outputs.PARSED_CONTEXT }}
        INIT_COMMENT_ID: ${{ steps.prepare.outputs.INIT_COMMENT_ID }}
        WORKING_BRANCH: ${{ steps.prepare.outputs.WORKING_BRANCH }}
        IS_NEW_BRANCH: ${{ steps.prepare.outputs.IS_NEW_BRANCH }}
        WORKING_DIR: ${{ inputs.junie_work_dir }}

    - name: Upload Junie working directory as artifact
      if: always() && steps.prepare.outputs.SHOULD_SKIP != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: junie-working-directory
        path: ${{ inputs.junie_work_dir }}
        retention-days: 7
        if-no-files-found: warn
        include-hidden-files: true

    - uses: EndBug/add-and-commit@v9
      name: Commit changes
      id: commit
      if: steps.prepare.outputs.SHOULD_SKIP != 'true' && inputs.silent_mode != 'true' && (steps.junie-run-results.outputs.ACTION_TO_DO == 'COMMIT_CHANGES' || steps.junie-run-results.outputs.ACTION_TO_DO == 'CREATE_PR')
      with:
        author_name: ${{ steps.prepare.outputs.ACTOR_NAME }}
        author_email: ${{ steps.prepare.outputs.ACTOR_EMAIL }}
        message: ${{ steps.junie-run-results.outputs.COMMIT_MESSAGE }}
        new_branch: ${{ steps.prepare.outputs.WORKING_BRANCH }}

    - name: Make Pull Request for the changes
      if: steps.prepare.outputs.SHOULD_SKIP != 'true' && inputs.silent_mode != 'true' && steps.junie-run-results.outputs.ACTION_TO_DO == 'CREATE_PR'
      id: pull-request
      shell: bash
      continue-on-error: true
      run: |
        bun run ${GITHUB_ACTION_PATH}/src/entrypoints/create-pr.ts
      env:
        GITHUB_TOKEN: ${{ steps.prepare.outputs.EJ_AUTH_GITHUB_TOKEN }}
        PARSED_CONTEXT: ${{ steps.prepare.outputs.PARSED_CONTEXT }}
        PR_TITLE: ${{ steps.junie-run-results.outputs.PR_TITLE }}
        PR_BODY: ${{ steps.junie-run-results.outputs.PR_BODY }}
        BASE_BRANCH: ${{ steps.prepare.outputs.BASE_BRANCH }}
        WORKING_BRANCH: ${{ steps.prepare.outputs.WORKING_BRANCH }}

    - name: Push changes
      id: push
      if: steps.prepare.outputs.SHOULD_SKIP != 'true' && inputs.silent_mode != 'true' && steps.junie-run-results.outputs.ACTION_TO_DO == 'PUSH'
      shell: bash
      run: |
        git push --set-upstream origin HEAD

    - name: Give feedback and update summary (success)
      if: success() && steps.prepare.outputs.SHOULD_SKIP != 'true'
      shell: bash
      run: |
        bun run ${GITHUB_ACTION_PATH}/src/entrypoints/give-feedback.ts
      env:
        IS_JOB_FAILED: false
        INIT_COMMENT_ID: ${{ steps.prepare.outputs.INIT_COMMENT_ID }}
        GITHUB_TOKEN: ${{ steps.prepare.outputs.EJ_AUTH_GITHUB_TOKEN }}
        PARSED_CONTEXT: ${{ steps.prepare.outputs.PARSED_CONTEXT }}
        WORKING_BRANCH: ${{ steps.prepare.outputs.WORKING_BRANCH }}
        BASE_BRANCH: ${{ steps.prepare.outputs.BASE_BRANCH }}
        ACTION_TO_DO: ${{ steps.junie-run-results.outputs.ACTION_TO_DO }}
        PR_LINK: ${{ steps.pull-request.outputs.pull-request-url }}
        COMMIT_SHA: ${{ steps.commit.outputs.commit_long_sha }}
        JUNIE_TITLE: ${{ steps.junie-run-results.outputs.JUNIE_TITLE }}
        JUNIE_SUMMARY: ${{ steps.junie-run-results.outputs.JUNIE_SUMMARY }}
        JSON_JUNIE_OUTPUT: ${{ steps.junie-run.outputs.json_output }}

    - name: Give feedback and update summary (failure)
      if: failure() && steps.prepare.outputs.SHOULD_SKIP != 'true'
      shell: bash
      run: |
        bun run ${GITHUB_ACTION_PATH}/src/entrypoints/give-feedback.ts
      env:
        IS_JOB_FAILED: true
        INIT_COMMENT_ID: ${{ steps.prepare.outputs.INIT_COMMENT_ID }}
        GITHUB_TOKEN: ${{ steps.prepare.outputs.EJ_AUTH_GITHUB_TOKEN }}
        PARSED_CONTEXT: ${{ steps.prepare.outputs.PARSED_CONTEXT }}
        WORKING_BRANCH: ${{ steps.prepare.outputs.WORKING_BRANCH }}
        BASE_BRANCH: ${{ steps.prepare.outputs.BASE_BRANCH }}
        ACTION_TO_DO: ${{ steps.junie-run-results.outputs.ACTION_TO_DO }}
        PR_LINK: ${{ steps.pull-request.outputs.pull-request-url }}
        COMMIT_SHA: ${{ steps.commit.outputs.commit_long_sha }}
        JUNIE_TITLE: ${{ steps.junie-run-results.outputs.JUNIE_TITLE }}
        JUNIE_SUMMARY: ${{ steps.junie-run-results.outputs.JUNIE_SUMMARY }}
        JSON_JUNIE_OUTPUT: ${{ steps.junie-run.outputs.json_output }}
        ERROR: ${{ steps.prepare.outputs.EXCEPTION || steps.junie-run-results.outputs.EXCEPTION }}